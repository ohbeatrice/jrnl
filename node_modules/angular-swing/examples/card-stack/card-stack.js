angular
    .module('card-stack-demo', ['gajus.swing', 'ngResource'])
.service('FeedService', ['$http', function ($http) {
    return {
        parseFeed: function (url) {
            return $http.jsonp('//ajax.googleapis.com/ajax/services/feed/load?v=1.0&num=50&callback=JSON_CALLBACK&q=' + encodeURIComponent(url));
        }
    };
}]).factory('NytOpinion', ['$resource', function($resource) {
  return $resource('http://api.nytimes.com/svc/topstories/v1/opinion.json?fields=byline,multimedia,photo&api-key=44ca79c2e333d9b1b559fd181988bf0f:12:72037481');
}])
.factory('NytWorld', ['$resource', function($resource) {
  return $resource('http://api.nytimes.com/svc/topstories/v2/world.json?fields=byline,multimedia,photo&api-key=44ca79c2e333d9b1b559fd181988bf0f:12:72037481');
}])
    .controller('card-stack-playground', ['$scope','NytOpinion', 'NytWorld', function ($scope, NytOpinion, NytWorld) {
    $scope.cards = [];
    var resp = [];
    $scope.wrongAnswerslist = [];
	
    $scope.gameOver = false;
    $scope.score = 0;
    $scope.total = 10;
    $scope.turn = 0;
    NytOpinion.get(function (data) {
        resp = data.results;
        $scope.addCards(resp.length, 'op');
    });
    NytWorld.get(function (data) {
        resp = data.results;
        $scope.addCards(resp.length, 'world');
    });

    $scope.addCards = function (count, type) {
        for (var i = 0; i < 5; i++) {
            //$scope.addCard($scope.cards[i].headline, $scope.cards[i].lead_paragraph); 
            if (resp[i].title && resp[i].abstract) {
                var newCard = {
                    title: resp[i].title,
                    lead: resp[i].abstract,
                    type: type,
                    image: resp[i].multimedia[2],
                    url: resp[i].url
                };
                $scope.cards.push(newCard);
            }
        }
        shuffle($scope.cards);
    };

    function shuffle(array) {
        var currentIndex = array.length,
            temporaryValue, randomIndex;

        // While there remain elements to shuffle...
        while (0 !== currentIndex) {

            // Pick a remaining element...
            randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex -= 1;

            // And swap it with the current element.
            temporaryValue = array[currentIndex];
            array[currentIndex] = array[randomIndex];
            array[randomIndex] = temporaryValue;
        }

        return array;
    }


    $scope.throwin = function (index) {
        $scope.cards.splice(index, 1);
    };

    $scope.throwout = function (card) {
        console.log('card transition out');
    };
		//Throw card to right (news)
    $scope.throwoutright = function (card) {
        //Check if the card is World News
        if (card.type == 'world') {
			$scope.score++;
			$scope.turn++;
			$scope.rightAnswerFunction();
        //If the answer is wrong
        } else {
			// Advance the turn
            $scope.turn++;
			$scope.wrongAnswerFunction('op');
			// Add the card to review list
            $scope.wrongAnswerslist.push(card);
        }
		// End game after 10 turns
        if ($scope.turn == 10) {
            $scope.gameOver = true;
        }
    };
	$('.success').one('webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend', function() {
		$('.success').removeClass('bounceInUp');
	});
    $scope.throwoutleft = function (card) {
		
        //Opinion
        if (card.type == 'op') {
			$scope.score++;
			$scope.turn++;
			$scope.rightAnswerFunction();
            //setTimeout($scope.rightAnswer = false, 2000);
        } else {
			// No points, add turn
            $scope.turn++;
			// Wrong Answer
			$scope.wrongAnswerFunction('world');
			// Add to review list
            $scope.wrongAnswerslist.push(card);
        }
		// End game after 10 turns
        if ($scope.turn == 10) {
            $scope.gameOver = true;
        }
		
    };
		
		//Right Answer FUnction
		$scope.rightAnswerFunction = function() {
			$scope.$apply(function () {
				$scope.feedback = 'Great Job!';
				// Correct answer sound
				$("#correct")[0].play(); 
				$('.success').addClass('bounceInUp');
			});
		};
		//Wrong Answer FUnction
		$scope.wrongAnswerFunction = function(type) {
			// Play Wrong answer sound
			$("#wrong")[0].play(); 
			if(type == 'op'){
				$scope.$apply(function () {
					$scope.feedback = 'Sorry, this is an opinion.';
					
				});	
			} else {
				$scope.$apply(function () {
					$scope.feedback = 'This is a news story.';	
				});	
			}
			$('.success').addClass('bounceInUp');
			
		};
		
}]);